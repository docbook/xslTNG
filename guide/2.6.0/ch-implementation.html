<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="no-js"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script><title>Chapter 5. Implementation details</title><link href="./css/pygments.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://purl.org/dc/elements/1.1/" rel="schema.dc"/><meta name="dc.modified" content="2025-09-14T09:03:45Z"/><meta name="dc.created" content="2025-09-14T09:03:45Z"/><meta name="generator" content="DocBook xslTNG version 2.6.0-SNAPSHOT / 4b1d3117 / SAXON HE 12.8"/><link href="./css/guide-toc.css" rel="stylesheet"/><link href="./css/docbook.css" rel="stylesheet" media="screen"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="css/guide.css" rel="stylesheet"/><link href="css/guide-online.css" rel="stylesheet"/><link href="media/xsltng-icon.png" rel="shortcut icon"/><script src="https://kit.fontawesome.com/c94d537c36.js" type="text/javascript" crossorigin="anonymous"></script><link rel="prev" href="ch-localization.html"/><link rel="next" href="ch-building.html"/><link rel="up" href="parti.html"/><link rel="home" href="index.html"/><script src="./js/annotations.js" defer="defer"></script><script src="./js/xlink.js" defer="defer"></script><script src="./js/persistent-toc.js" defer="defer"></script><script src="./js/pagetoc.js" data-dynamic-pagetoc="true" defer="defer"></script><script src="./js/copy-verbatim.js" defer="defer"></script><script src="./js/chunk-nav.js" defer="defer"></script></head><body class="chapter component"><nav class="top"><span class="nav"><a title="DocBook xslTNG Reference" href="index.html"><i class="fas fa-home"></i></a> <a href="ch-localization.html" title="Chapter  4 .  Localization"><i class="fas fa-arrow-left"></i></a> <a title="Part  I .  Introduction" href="parti.html"><i class="fas fa-arrow-up"></i></a> <a title="Chapter  6 .  Building the stylesheets" href="ch-building.html"><i class="fas fa-arrow-right"></i></a></span><span class="title"><i class="title">DocBook xslTNG Reference</i></span><span class="logo"><img src="media/xsltng-inverted.png"/></span></nav><div class="pagebody"><main><section id="implementation" db-chunk="ch-implementation.html" db-id="d147e4105" class="chapter component"><header><h1>Chapter <span class="label">5</span><span class="sep">. </span>Implementation details</h1></header><div class="db-bfs"><p>This section sketches out some features of the implementation.
It would probably be better to build an annotated
<a href="https://tdg.docbook.org/" class="link">Definitive Guide</a> or
something, but this will have to do for now.
</p></div><section id="custom-chunking" class="section"><header><h2><span class="label">5<span class="sep">.</span>1</span><span class="sep">. </span>Customizing chunking</h2></header><p>Chunking is controlled by the <a href="p_chunk-include.html"><code class="paramname">$chunk-include</code></a><span class="indexterm" id="custom-chunking_para1_indexterm1"></span> and
<a href="p_chunk-exclude.html"><code class="paramname">$chunk-exclude</code></a><span class="indexterm" id="custom-chunking_para1_indexterm2"></span> parameters. These parameters are both
strings that must contain an XPath expression.</p><p>For each node in the document, the <a href="p_chunk-include.html"><code class="paramname">$chunk-include</code></a><span class="indexterm" id="custom-chunking_para2_indexterm1"></span>
parameter is evaluated. If it does not return an empty sequence, the element
is considered a chunking candidate. In this case, the
<a href="p_chunk-exclude.html"><code class="paramname">$chunk-exclude</code></a><span class="indexterm" id="custom-chunking_para2_indexterm2"></span> parameter is evaluated. If the exclude
expression <em>does</em> return an empty sequence, then the element identified
becomes a chunk. (If the exclude expression returns a non-empty value, the element
will not become a chunk.)</p></section><section id="units" class="section"><header><h2><span class="label">5<span class="sep">.</span>2</span><span class="sep">. </span>Lengths and units</h2></header><p>Lengths appear in the context of images (width and height) and
tables (column widths). Several different units of length are
possible: absolute lengths (e.g., 3in), relative lengths (e.g., 3*),
and percentages (e.g., 25%). In some contexts, these can be combined:
a column width of “3*+0.5in” should have a width equal to 3 times the
relative width plus ½ inch.</p><p>In practice, some of the more complicated forms in <a href="references.html#calstable" class="xref xref-bibliomixed"><span class="label"><span class="abbrev">TR
9502:1995</span></span></a> have no direct mapping to the units available in
HTML and CSS. The stylesheets attempt to specify a mapping that’s
close. Broadly, they take the nominal width of the table
(<a href="p_nominal-page-width.html"><code class="paramname">$nominal-page-width</code></a><span class="indexterm" id="units_para2_indexterm1"></span>), subtract out the fixed
widths, divide up the remaining widths proportionally among the
relative widths, and compute final widths. The final widths can be
expressed either in absolute terms or as percentages.</p><p>In handling the width and height of images, the intrinsic width
and height of the image in pixels are converted into lengths by
dividing by <a href="p_pixels-per-inch.html"><code class="paramname">$pixels-per-inch</code></a><span class="indexterm" id="units_para3_indexterm1"></span>. Nominal widths are
taken into consideration if necessary.</p><div class="admonition note"><div><div class="icon">ⓘ</div><div class="body"><header><div class="title">Note</div></header><div><p>Determining the intrinsic size of an image depends on an extension function.
See <a href="ch-using.html#extensions" class="xref xref-section">Section <span class="label">2<span class="sep">.</span>6</span>, “Extension functions”</a>. Many bitmap image formats are supported.
The bounding box of EPS images is used, if it’s present. The intrinsic size of
SVG images is not available.</p></div></div></div></div><p>The list of recognized units (in, cm, etc.) are taken from
<a href="v_unit-scale.html"><code class="varname">$v:unit-scale</code></a><span class="indexterm" id="units_para4_indexterm1"></span>.</p></section><section id="line-numbers" class="section"><header><h2><span class="label">5<span class="sep">.</span>3</span><span class="sep">. </span>Line numbers</h2></header><p>In the <code class="literal">lines</code> and <code class="literal">table</code> styles, line
numbers may be added to the beginning of some (or all) lines. Prior to version
1.10.0, the stylesheets inserted the numbers without any padding:</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-xml numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"line"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"ln"</span><span class="nt">&gt;</span>5<span class="nt">&lt;/span&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"ld"</span><span class="nt">&gt;</span>The<span class="w"> </span>line<span class="w"> </span>of<span class="w"> </span>text<span class="nt">&lt;/span&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/span&gt;</span></code></span></span></pre></div><p>(The newlines and indentation in these examples are for clarity. In practice, these
are inside a <code class="tag tag-element">pre</code> where every
space counts and they’re all run together with line breaks only occurring
between lines.)</p><p>In a graphical browser with CSS support, this looked fine. But
without CSS, the line numbers and the text that followed them could
flow together and the alignment of the numbers was unclear.</p><p>Starting in version 1.10.0, the stylesheets insert padding
spaces before each number so that they will all be aligned. If the
largest line number is three digits long, every number smaller than
100 will be padded to a width of three characters. A single space is
added after the number to separate it from the text that follows.
An additional separator may also be inserted, as shown here.</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-xml numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"line"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"ln"</span><span class="nt">&gt;</span><span class="w"> </span>5<span class="w"> </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"nsep"</span><span class="nt">&gt;</span>|<span class="nt">&lt;/span&gt;&lt;/span&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;span</span><span class="w"> </span><span class="na">class=</span><span class="s">"ld"</span><span class="nt">&gt;</span>The<span class="w"> </span>line<span class="w"> </span>of<span class="w"> </span>text<span class="nt">&lt;/span&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/span&gt;</span></code></span></span></pre></div><p>These changes have no visible effect when CSS is used to style
the verbatim environment. But without CSS, the numbers are aligned and
separated from the text that follows. The
<a href="p_verbatim-number-separator.html"><code class="paramname">$verbatim-number-separator</code></a><span class="indexterm" id="line-numbers_para5_indexterm1"></span> is generally
suppressed by CSS, but is visible in text browsers.</p></section><section id="processing-mediaobjects" class="section"><header><h2><span class="label">5<span class="sep">.</span>4</span><span class="sep">. </span>Processing mediaobjects</h2></header><p>Starting in version 1.11.0, the way media objects are processed has been
refactored. This is designed to support fallback at both the object
level (<code class="tag tag-element">imageobject</code>, <code class="tag tag-element">audioaobject</code>, <code class="tag tag-element">videoobject</code>,
<code class="tag tag-element">textobject</code>, and <code class="tag tag-element">imageobjectco</code>) and at the data
level (<code class="tag tag-element">imagedata</code>, <code class="tag tag-element">audiodata</code>, <code class="tag tag-element">videodata</code>,
and <code class="tag tag-element">textdata</code> within the objects).</p><p>Each data element and object element is processed in the
<a href="m_mediaobject-info.html"><code class="mode">m:mediaobject-info</code></a> mode. This returns a map for each object
that contains an array of maps, one for each data element:</p><div id="processing-mediaobjects_tab1" class="formalobject table"><header><div class="title">Table <span class="label">5<span class="sep">.</span>1</span><span class="sep">. </span>The object map</div></header><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>content-types</code></td><td>An array of the distinct content types in the data elements</td></tr><tr><td><code>datas</code></td><td>An array of data maps</td></tr><tr><td><code>extensions</code></td><td>An array of the distinct extensions in the data elements</td></tr><tr><td><code>node</code></td><td>The media object node</td></tr></tbody></table></div><p>Each data map has the following structure:</p><div id="processing-mediaobjects_tab2" class="formalobject table"><header><div class="title">Table <span class="label">5<span class="sep">.</span>2</span><span class="sep">. </span>The data map</div></header><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>align</code></td><td>The alignment of the data (if specified)</td></tr><tr><td><code>content-type</code></td><td>The computed content type for the data</td></tr><tr><td><code>contentheight</code></td><td>The content height of the data (if specified<sup id="fn-depth-fref" class="footnote-number table-footnote"><a href="#fn-depth-fnote">a</a></sup>)</td></tr><tr><td><code>contentwidth</code></td><td>The content width of the data (if specified)</td></tr><tr><td><code>extension</code></td><td>The extension of the data file (if there is one)</td></tr><tr><td><code>fileref</code></td><td>The original <code class="tag tag-attribute">fileref</code> attribute value</td></tr><tr><td><code>height</code></td><td>The height of the data (if specified<sup id="processing-mediaobjects_tab2_tgroup1_tbody1_row7_entry2_footnoteref1-fref" class="footnote-number table-footnote"><a href="#fn-depth-fnote">a</a></sup>)</td></tr><tr><td><code>href</code></td><td>The computed <code class="tag tag-attribute">href</code> value for the HTML element;
this takes account of the <a href="p_mediaobject-input-base-uri.html"><code class="paramname">$mediaobject-input-base-uri</code></a><span class="indexterm" id="processing-mediaobjects_tab2_tgroup1_tbody1_row8_entry2_indexterm1"></span> and
<a href="p_mediaobject-output-base-uri.html"><code class="paramname">$mediaobject-output-base-uri</code></a><span class="indexterm" id="processing-mediaobjects_tab2_tgroup1_tbody1_row8_entry2_indexterm2"></span>).
</td></tr><tr><td><code>node</code></td><td>The data element</td></tr><tr><td><code>params</code></td><td>Any <code class="tag tag-element">multimediaparams</code> associated with the data element</td></tr><tr><td><code>properties</code></td><td>The properties of the element (as returned by the extension funtions;
this can include EXIF data and metadata)</td></tr><tr><td><code>scale</code></td><td>The scaling factor (if there is one) or 1.0</td></tr><tr><td><code>scalefit</code></td><td>True if the image should be scaled to fit (implicitly or explicitly)</td></tr><tr><td><code>uri</code></td><td>The computed absolute URI of the input data</td></tr><tr><td><code>valign</code></td><td>The vertical alignment of the data (if specified)</td></tr><tr><td><code>width</code></td><td>The width of the data (if specifieid)</td></tr></tbody></table><div class="footnotes table-footnotes"><div class="footnote" id="fn-depth-fnote"><div class="footnote-number"><sup class="footnote-number table-footnote"><a href="#fn-depth-fref">a</a></sup></div><div class="footnote-body"><p>DocBook
uses “depth” instead of “height”, but we convert
it to height for consistency with most other systems.</p></div></div></div></div><p>The <code class="literal">uri</code> and <code class="literal">href</code> properties are computed
by processing the data elements in the <a href="m_mediaobject-uris.html"><code class="mode">m:mediaobject-uris</code></a> mode.</p><p>Armed with information about the objects and the data associated with them,
the stylesheets proceed to choose an object and then process it. Each object is
considered in turn, if any of the data elements it contains were excluded, then it is
rejected. The first object where all of the elements are acceptable is selected.</p><p>Consider this example:</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="11"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;mediaobject&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;imageobject&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;imagedata</span><span class="w"> </span><span class="na">fileref=</span><span class="s">"image.svg"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;imagedata</span><span class="w"> </span><span class="na">fileref=</span><span class="s">"image.eps"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;imagedata</span><span class="w"> </span><span class="na">fileref=</span><span class="s">"image.png"</span><span class="w"> </span><span class="na">width=</span><span class="s">"4in"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/imageobject&gt;</span></code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;imageobject&gt;</span></code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;imagedata</span><span class="w"> </span><span class="na">fileref=</span><span class="s">"image.svg"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;imagedata</span><span class="w"> </span><span class="na">fileref=</span><span class="s">"image.png"</span><span class="w"> </span><span class="na">width=</span><span class="s">"40em"</span><span class="nt">/&gt;</span></code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/imageobject&gt;</span></code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/mediaobject&gt;</span></code></span></span></pre></div><p>If this is being processed for online presentation, the default
value of <a href="p_mediaobject-exclude-extensions.html"><code class="paramname">$mediaobject-exclude-extensions</code></a><span class="indexterm" id="processing-mediaobjects_para7_indexterm1"></span> will exclude the
EPS file. Because one of it’s data elements was excluded, the processor will choose
the object containing only the SVG and PNG images for online presentation.</p><p>Once an object is selected, an appropriate wrapper is created and all
of the alternatives are placed within it. So the example above will result in
<code class="tag tag-element">picture</code> element containing
a
<code class="tag tag-element">source</code> for the SVG image and an
<code class="tag tag-element">img</code> for the fallback PNG.
</p><div class="admonition note"><div><div class="icon">ⓘ</div><div class="body"><header><div class="title">Note</div></header><div><p>Consistent with HTML, only the size, scaling, and alignment attributes of
the <em>last</em> alternative data element are considered! These apply
irrespective of which alternative is selected.</p></div></div></div></div><section id="mediaobject-uris" class="section"><header><h3><span class="label">5<span class="sep">.</span>4<span class="sep">.</span>1</span><span class="sep">. </span>Mediaobject URIs</h3></header><p>Media object URIs are tricky to handle. It’s most
convenient if the URIs in the source documents point to the actual media files.
This allows extensions, like the image properties
<a href="ch-using.html#extensions" class="link">extension function</a>, to access the files.
At the same time, the references generated in the HTML have to point to the
locations where they will be published.</p><p>In previous versions, the stylesheets attempted (broadly) to use
the relative difference between the input and output base URIs to work out
the correct relative URIs for media. That imposed restrictions on the
authoring environment that weren’t always easy to work with.
Starting in version 2.0.6, the mechanisms for finding sources
and producing references in the output has changed. Three parameters
are used:</p><dl class="long-terms variablelist"><div class="varlistentry"><dt><span class="term"><a href="p_mediaobject-input-base-uri.html"><code class="paramname">$mediaobject-input-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle1_term1_indexterm1"></span></span></dt><dd><p>If the <a href="p_mediaobject-input-base-uri.html"><code class="paramname">$mediaobject-input-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle1_li1_para1_indexterm1"></span> is empty (the default),
then URIs in the source document are assumed to be relative to the base URI on
which they occur. This is the usual case if you mix XML and media into the same
directory structure on the filesystem.</p><p>If the <a href="p_mediaobject-input-base-uri.html"><code class="paramname">$mediaobject-input-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle1_li1_para2_indexterm1"></span> is not empty, it is
used to resolve all media URIs. If it’s initialized with a relative URI, that URI will
be made absolute against the base URI if the input document.</p></dd></div><div class="varlistentry"><dt><span class="term"><a href="p_mediaobject-output-base-uri.html"><code class="paramname">$mediaobject-output-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle2_term1_indexterm1"></span></span></dt><dd><p>If the <a href="p_mediaobject-output-base-uri.html"><code class="paramname">$mediaobject-output-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle2_li1_para1_indexterm1"></span> is empty (the default),
then URIs in the output are treated as parallel to the URIs in the input. If the
reference <code class="filename">../image.png</code> works in the source document, it’s assumed
that will also work in the output document.</p><p>If the <a href="p_mediaobject-output-base-uri.html"><code class="paramname">$mediaobject-output-base-uri</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle2_li1_para2_indexterm1"></span> is not empty, it is
the base URI used for media objects. If this is a relative URI, it is taken to be
relative to the root of the output hierarchy.</p><p>Suppose the output base URI is <code class="uri">https://images.example.com/</code>, then
a reference to <code class="filename">image.png</code> will appear as
<code class="uri">https://images.example.com/image.png</code> in the output.</p><p>If the output base URI is <code class="uri">media/</code>, then
a reference to <code class="filename">image.png</code> will appear as
<code class="uri">media/image.png</code> in the output. If the document is chunked, the paths back
to the output directory are relative. In otherwords, if the reference to
<code class="filename">image.png</code> appears in a chunk that will be located at
<code class="filename">back/appendix.html</code>, then the media URI will be
<code class="uri">../media/image.png</code>.
</p></dd></div><div class="varlistentry"><dt><span class="term"><a href="p_mediaobject-output-paths.html"><code class="paramname">$mediaobject-output-paths</code></a><span class="indexterm" id="mediaobject-uris_vl1_vle3_term1_indexterm1"></span></span></dt><dd><p>This parameter controls whether the relative paths in the input URIs apply
to the output URIs as well. If the parameter <span class="glossterm"><a href="glossary.html#glossary_ge5">is true</a></span>,
the output base URI is <code class="uri">media/</code>, and the input URI is
<code class="filename">path/to/image.png</code>, then the output reference will be to
<code class="uri">media/path/to/image.png</code>. If it’s false, then the output reference
will be to <code class="uri">media/image.png</code>.
</p></dd></div></dl><p>For a further discussion of the options, see
<a href="ch-customizing.html#media" class="xref xref-section">Section <span class="label">3<span class="sep">.</span>5</span>, “Managing media”</a>.</p><div class="admonition important"><div><div class="icon">☝</div><div class="body"><header><div class="title">Important</div></header><div><p>The stylesheets are not responsible for actually copying the media files
into the correct locations in the output. The stylesheets only generate the HTML
files and the references. You must copy the images and other media with some
other process.</p></div></div></div></div></section></section><section id="header-templates" class="section"><header><h2><span class="label">5<span class="sep">.</span>5</span><span class="sep">. </span>Templates</h2></header><p>It’s difficult to make title pages for documents easy to customize. There is <em>a lot</em> of
      variation between documents and the styles can have very precise design constraints. At the end of the day, if you
      need complete control, you can define a template that matches the element in the <a href="m_generate-titlepage.html"><code class="mode">m:generate-titlepage</code></a>
      mode and generate all of the markup you wish. The parameter <a href="p_default-templates-uri.html"><code class="paramname">$default-templates-uri</code></a><span class="indexterm" id="header-templates_para1_indexterm1"></span> points to
      the file with default templates.</p><p>The default title page handling attempts to make some declarative customization
possible by using templates. A typical header template looks like this:</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="10"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;db:section&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;header&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">    </span><span class="nt">&lt;tmp:apply-templates</span><span class="w"> </span><span class="na">select=</span><span class="s">"db:title"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">      </span><span class="nt">&lt;h2&gt;&lt;tmp:content/&gt;&lt;/h2&gt;</span></code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code><span class="w">    </span><span class="nt">&lt;/tmp:apply-templates&gt;</span></code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">    </span><span class="nt">&lt;tmp:apply-templates</span><span class="w"> </span><span class="na">select=</span><span class="s">"db:subtitle"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">      </span><span class="nt">&lt;h3&gt;&lt;tmp:content/&gt;&lt;/h3&gt;</span></code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">    </span><span class="nt">&lt;/tmp:apply-templates&gt;</span></code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;/header&gt;</span></code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/db:section&gt;</span></code></span></span></pre></div><p>Any HTML element in the template will be copied to the output. The semantics
of a “template apply templates” element (<code class="tag tag-element">tmp:apply-templates</code>) is that
it runs the ordinary <code class="tag tag-element">xsl:apply-templates</code> instruction on the elements that
match its select expression. If they result is the empty sequence (e.g, if there is no 
<code class="tag tag-element">subtitle</code>), nothing is output. If there is a result, the content of the
<code class="tag tag-element">tmp:apply-templates</code> element is processed. Anywhere that
<code class="tag tag-element">tmp:content</code> appears, the result of applying templates will be output.</p><p>In this example, if the title is “H<sub>2</sub>O” and there is no subtitle,
the resulting HTML title page will be:</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="3"><pre class="language-xml numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;header&gt;</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">  </span><span class="nt">&lt;h2&gt;</span>H<span class="nt">&lt;sub&gt;</span>2<span class="nt">&lt;/sub&gt;</span>O<span class="nt">&lt;/h2&gt;</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/header&gt;</span></code></span></span></pre></div></section><section id="annotations" class="section"><header><h2><span class="label">5<span class="sep">.</span>6</span><span class="sep">. </span>Annotations</h2></header><p>The stylesheets fully support annotations, including a number
of presentation styles enabled by JavaScript in the browser. They also
support an extension of the documented semantics of
<code class="tag tag-element">annotation</code>.</p><p>Annotations are applied to elements with links. Either the
element must point to its annotations (with an <code class="tag tag-attribute">annotations</code>
attribute) or the annotations must point to the elements they annotate
(with an <code class="tag tag-attribute">annotates</code> attribute). These are documented as
ID/IDREF links but they are not <code>IDREFS</code> attributes
because annotations may be stored separately.</p><p>Starting in version 1.5.1, the <cite class="citetitle">DocBook xslTNG
Stylesheets<a class="annomark" href="#annotations_an1"><sup>⌖</sup><sup class="num">1</sup></a></cite> support a non-standard extension: if you place
the string <code>xpath:</code> in the <code class="tag tag-attribute">annotates</code> attribute of
an <code class="tag tag-element">annotation</code>, then the rest of the attribute is assumed to contain
an XPath expression that points to the element(s) to which the annotation
applies. (If you want to put IDREF values before the <code>xpath:</code> token,
that’s fine, but you can’t put them after; the expression continues to the end
of the attribute value.)</p><p>Suppose, for example, that you wanted to annotate the stylesheet
title in the previous paragraph. The standard mechanisms would require that
you either put an <code class="tag tag-attribute">xml:id</code> attribute on the element or point to the
annotation from the element. With the XPath extension, you can do this:</p><div class="pre-wrap programlisting-wrap highlight" db-startinglinenumber="1" db-numberoflines="7"><pre class="language-xml long numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">1 <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;annotation</span></code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">   </span><span class="na">annotates=</span><span class="s">"xpath:preceding-sibling::db:para/db:citetitle"</span></code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="w">   </span><span class="na">xmlns:db=</span><span class="s">"http://docbook.org/ns/docbook"</span><span class="nt">&gt;</span></code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;para&gt;</span>This<span class="w"> </span>annotation<span class="w"> </span>applies<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>stylesheet<span class="w"> </span>title.</code></span></span>
<span class="line" db-line="5"><span class="ln">5 <span class="nsep">|</span></span><span class="ld"><code>For<span class="w"> </span>a<span class="w"> </span>discussion<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>annotation,<span class="w"> </span>see<span class="w"> </span>the</code></span></span>
<span class="line" db-line="6"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>following<span class="w"> </span>paragraphs.<span class="nt">&lt;/para&gt;</span></code></span></span>
<span class="line" db-line="7"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code><span class="nt">&lt;/annotation&gt;</span></code></span></span></pre></div><p>When the XPath expression is evaluated, the <code class="tag tag-element">annotation</code>
element is the context item. Often, this means that you’ll want to start
the expression with <code>id()</code> or <code>/</code>.</p><p>The namespace context for the expression is also the <code class="tag tag-element">annotation</code>
element, that’s why I’ve added the DocBook namespace binding for the
<code class="tag tag-prefix">db</code> prefix. In practice, if you’re doing this on
several annotations, you can just put all the namespace bindings on a common
ancestor. All of the bindings <em>in scope</em> on the
<code class="tag tag-element">annotation</code> element are available in the expression.</p><p>Caveats:</p><ol class="orderedlist" type="1"><li><p>There’s no way to have multiple XPath expressions. You can’t put
“<code>xpath:</code>” in there twice. If you want an annotation to apply to
multiple elements, you’ll have to construct a single expression that selects
all the elements, or duplicate the annotation, or use ID/IDREF links.</p><p>If this turns out to be a serious limitation in practice, additional
syntax could be added to support multiple expressions, but it doesn’t
<em>seem</em> necessary.</p></li><li><p>You can only select elements. There’s no way to select the third word
in a particular paragraph, for example, unless it already has some markup
around it. There’s also no way to select a comment or a processing instruction.
</p></li></ol><p>The placement of the annotation marker (“⌖” by default) can also be
controlled globally and on individual annotations. The
<a href="p_annotation-placement.html"><code class="paramname">$annotation-placement</code></a><span class="indexterm" id="annotations_para8_indexterm1"></span> parameter provides global control.
To specify the position for an individual annotation, put the token
“<code>before</code>” or “<code>after</code>” in the <code class="tag tag-attribute">role</code>
attribute on the <code class="tag tag-element">annotation</code>.</p></section><section id="preprocessing-pipeline" class="section"><header><h2><span class="label">5<span class="sep">.</span>7</span><span class="sep">. </span>The pre- and post-processing pipeline</h2></header><p>Processing a DocBook document is a multi-stage process. The
original document is transformed several times before converting it to
HTML. The standard transformations are:</p><ol class="orderedlist" type="1"><li id="step-first-00-transform"><p>Adjust the logical structure. Adds an XML base attribute to the root of the
document and converts media object <code class="tag tag-attribute">entityref</code> attributes
into <code class="tag tag-attribute">fileref</code> attributes.
</p></li><li><p>Perform XInclude processing. Only occurs if the appropriate
extension function is available and if the document contains XInclude
element.
</p></li><li><p>Convert DocBook 4.x to DocBook 5.x. Only occurs if the root element is not in
a namespace.
</p></li><li><p>Peform transclusion.
</p></li><li><p>Perform profiling.
</p></li><li><p>Normalize the content. This removes a lot of variation that’s allowed for authoring.
For example, authors aren’t required to use an <code class="tag tag-element">info</code> element if a formal object
has only a title. This process adds the <code class="tag tag-element">info</code> element if it’s missing.
</p></li><li><p>Resolve annotations.
</p></li><li><p>Process XLink link bases.
</p></li><li><p>Validate. Only occurs if the appropriate
extension function is available and the stylesheet specifies a
<a href="p_relax-ng-grammar.html"><code class="paramname">$relax-ng-grammar</code></a><span class="indexterm" id="preprocessing-pipeline_ol1_li9_para1_indexterm1"></span>.
</p></li><li id="step-last-oxy-markup"><p>Process Oxygen change markup. Only occurs if 
<a href="p_oxy-markup.html"><code class="paramname">$oxy-markup</code></a><span class="indexterm" id="step-last-oxy-markup_para1_indexterm1"></span> <span class="glossterm"><a href="glossary.html#glossary_ge5">is true</a></span> and the document contains
Oxygen change markup processing instructions.
</p></li></ol><p>A customization can introduce transformations to the original
document using three parameters:</p><dl class="long-terms variablelist"><div class="varlistentry"><dt><span class="term"><a href="p_transform-original.html"><code class="paramname">$transform-original</code></a><span class="indexterm" id="preprocessing-pipeline_vl1_vle1_term1_indexterm1"></span></span></dt><dd><p>This transform runs before step <a href="#step-first-00-transform" class="xref xref-listitem"><span class="label">1</span></a>
in the standard transformations. Note that this is before XInclude processing, before
transclusion, before any other processing. If you need to make a change to the 
original input document, this is where you can do it, but for preprocessing
“the XML document that will be transformed”, the <a href="p_transform-before.html"><code class="paramname">$transform-before</code></a><span class="indexterm" id="preprocessing-pipeline_vl1_vle1_li1_para1_indexterm1"></span>
parameter is likely to be a better choice.</p><p>If this transformation is used, it must take special care to preserve the 
base URI of the original document by adding an <code class="tag tag-attribute">xml:base</code>
attribute to the root element (if it doesn’t already have one).</p><p>Only the first transformation in the list has access to the original base URI.
If it isn’t preserved, relative references to other documents will be resolved against
the static base URI of the stylesheet and not the URI of the original document. That’s
unlikely to be correct.</p></dd></div><div class="varlistentry"><dt><span class="term"><a href="p_transform-before.html"><code class="paramname">$transform-before</code></a><span class="indexterm" id="preprocessing-pipeline_vl1_vle2_term1_indexterm1"></span></span></dt><dd><p>This transformation runs after step <a href="#step-last-oxy-markup" class="xref xref-listitem"><span class="label">10</span></a>. Its
input is the DocBook document that will be transformed into HTML.
</p></dd></div><div class="varlistentry"><dt><span class="term"><a href="p_transform-after.html"><code class="paramname">$transform-after</code></a><span class="indexterm" id="preprocessing-pipeline_vl1_vle3_term1_indexterm1"></span></span></dt><dd><p>This transformation runs after the DocBook document has been transformed into HTML.
The resulting HTML document is not valid HTML, but contains islands of valid HTML that will
be separated out into chunks by subsequent processing.
</p></dd></div></dl><p>(If you need
to insert a transformation in the middle of the standard transformations,
you’ll have to update the <a href="v_standard-tranasforms.html"><code class="varname">$v:standard-transforms</code></a><span class="indexterm" id="preprocessing-pipeline_para3_indexterm1"></span>
variable in your customization.)</p><p>Each of the transformation variables holds a list of transforms that will
be applied in the order specified. Each member of the list can be a map or a
string. If a string is provided, it’s the equivalent of providing this map:
</p><div class="pre-wrap programlisting-wrap" db-startinglinenumber="1" db-numberoflines="3"><pre class="language-xpath numbered programlisting verbatim verblines"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>map {</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>  'stylesheet-location': $the-string</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code>}</code></span></span></pre></div><p>The map can have several keys:</p><div id="preprocessing-pipeline_tab1" class="formalobject table"><header><div class="title">Table <span class="label">5<span class="sep">.</span>3</span><span class="sep">. </span>The transformation map</div></header><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>stylesheet-location</code></td><td>The location of the XSLT stylesheet that performs this transformation.
This key is required.</td></tr><tr><td><code>extra-params</code></td><td>A map of QName/value pairs. These parameters will be made available to
the transformation in addition to all of the standard parameters available to a
standard DocBook stylesheet.</td></tr><tr><td><code>functions</code></td><td>A list of functions (expressed as EQNames). The transformation will only be
run if every extension function listed is available.</td></tr><tr><td><code>test</code></td><td>An arbitrary XPath expression. The expression will be evaluated with the
document as the context item. If it returns an effective boolean value of true,
the transformation will be run.</td></tr></tbody></table></div></section></section><footer><div class="annotations"><div class="annotation-wrapper title">Annotations</div><div id="annotations_an1" class="annotation-wrapper"><div class="annotation-body"><div class="annotation-header"><div class="annotation-close"></div><div class="annotation-title"><span class="annomark"><sup>⌖</sup><sup class="num">1</sup> </span></div></div><div class="annotation-content">
<p>This annotation applies to the stylesheet title. For a discussion
of this annotation, see the following paragraphs.
</p>
</div></div></div></div></footer></main><nav class="pagetoc"><div class="tocwrapper"></div></nav></div><nav class="bottom"><div class="navrow"><div class="navleft"><a title="Chapter  4 .  Localization" href="ch-localization.html"><i class="fas fa-arrow-left"></i></a></div><div class="navmiddle"><a title="" href="index.html"><i class="fas fa-home"></i></a></div><div class="navright"><a title="Chapter  6 .  Building the stylesheets" href="ch-building.html"><i class="fas fa-arrow-right"></i></a></div></div><div class="navrow"><div class="navleft navtitle">Chapter  4 .  Localization</div><div class="navmiddle"><a title="Part  I .  Introduction" href="parti.html"><i class="fas fa-arrow-up"></i></a></div><div class="navright navtitle">Chapter  6 .  Building the stylesheets</div></div><div class="infofooter"><span class="copyrightfooter"><a href="dbcpyright.html">Copyright</a> © 2020–2024 Norman Walsh.</span></div><nav class="tocopen"></nav><nav class="toc"></nav><!-- Hide ToC details from user agents that don’t support JS --><script type="text/html" class="tocopen"><i class="far fa-book"></i></script><script type="text/html" class="toc"><header><span>Table of Contents</span><span class="close"><i class="far fa-window-close"></i></span><p class="ptoc-search"><input class="ptoc-search" placeholder="Search" style="width: 80%"/></p></header><div db-persistent-toc="persistent-toc.html" db-prefix="">Loading…</div></script></nav><script type="text/html" class="annotation-close"><i class="far fa-window-close"></i></script></body></html>